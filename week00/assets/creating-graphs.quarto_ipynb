{
  "cells": [
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "---\n",
        "title: \"Creating Graphs\"\n",
        "date: \"2025-06-06\"\n",
        "---\n",
        "\n",
        "\n",
        "## An example\n",
        "\n",
        "### The task\n",
        "\n",
        "Is there a difference between how much men and women make? How does it vary by age?\n",
        "\n",
        "The topic is related to the case study on [gender gap in earnings](https://gabors-data-analysis.com/casestudies/#ch09a-estimating-gender-and-age-differences-in-earnings).\n",
        "\n",
        "### Preparation\n",
        "\n",
        "As a case study, consider the earnings case study from the Data Analysis textbook\n",
        "\n",
        "-   Have a look at the info [readme](https://osf.io/cgfrq)\n",
        "-   Download `morg-2014-emp.csv` from [earnings data](https://osf.io/4ay9x)\n",
        "-   Download cpsx.pdf, which is an [old school codebook](https://osf.io/uqe8z)\n",
        "-   read in morg-2014-emp.csv\n",
        "\n",
        "**One state**\n",
        "\n",
        "Let us start filtering on the largest state\n",
        "\n",
        "```         \n",
        "1. Create an ordered freq table of state, and filter on the largest one\n",
        "```\n",
        "\n",
        "I used RStudio with Github copilot to write all three code snippets. It automatically guessed the third bit.\n",
        "\n",
        "```{{r}}\n",
        "\n",
        "# setup\n",
        "library(tidyverse)\n",
        "\n",
        "# ordered freq table of state\n",
        "morg %>%\n",
        "  group_by(state) %>%\n",
        "  summarise(n = n()) %>%\n",
        "  arrange(desc(n)) %>%\n",
        "  mutate(state = fct_reorder(state, n)) %>%\n",
        "  ggplot(aes(x = state, y = n)) +\n",
        "  geom_col() +\n",
        "  coord_flip() +\n",
        "  labs(title = \"Number of Employees by State in Morg\",\n",
        "       x = \"State\",\n",
        "       y = \"Number of Employees\") +\n",
        "  theme_minimal()\n",
        "\n",
        "# find the largest state in terms of number of obs\n",
        "\n",
        "state_max=morg %>%\n",
        "  group_by(state) %>%\n",
        "  summarise(n = n()) %>%\n",
        "  arrange(desc(n)) %>%\n",
        "  slice(1) %>%\n",
        "  pull(state)\n",
        "\n",
        "\n",
        "# filter morg for the largest state\n",
        "morg_largest_state <- morg %>%\n",
        "  filter(state == state_max)\n",
        "\n",
        "```\n",
        "\n",
        "\n",
        "Hold, what is does max state=5 mean? Ask ChatGPT.\n",
        "\n",
        "![](../../images/earnings-state5.png)\n",
        "\n",
        "Save this file as `morg-2014-emp-state5.csv`. You can find it also [at the data section here](/data/earnings/morg-2014-emp-state5.csv)\n",
        "\n",
        "\n",
        "**Get to know the file**\n",
        "\n",
        "- **Upload the file** and ask for a variable dictionary. After 2 iterations, I used this. \n",
        "\n",
        "```\n",
        "Create a variable dictionary. Use the pdf i shared earlier. Output as markdown. For each variable: varname, labels, type, coverage (% missing), mean and mode. Round up numbers. Look at cps and provide short labels. Get me an .md I can download.\n",
        "\n",
        "```\n",
        "\n",
        "### Let us do graphs\n",
        "\n",
        "**First try**\n",
        "\n",
        "```\n",
        "Is there a gender gap in earnings? Show me a graph.\n",
        "```\n",
        "\n",
        "ChatGPT will run Data Analysis -- create a short Python script and display a graph.\n",
        "\n",
        "```{{python}}\n",
        "import matplotlib.pyplot as plt\n",
        "\n",
        "# Check for gender and earnings columns\n",
        "if \"sex\" in df.columns and \"earnwke\" in df.columns:\n",
        "    # Drop rows with missing or zero earnings\n",
        "    df_filtered = df[(df[\"earnwke\"].notna()) & (df[\"earnwke\"] > 0)]\n",
        "\n",
        "    # Group by sex and calculate mean earnings\n",
        "    gender_earnings = df_filtered.groupby(\"sex\")[\"earnwke\"].mean().reset_index()\n",
        "    gender_earnings[\"earnwke\"] = gender_earnings[\"earnwke\"].round(2)\n",
        "\n",
        "    # Create a bar plot\n",
        "    plt.figure(figsize=(6, 4))\n",
        "    plt.bar(gender_earnings[\"sex\"], gender_earnings[\"earnwke\"])\n",
        "    plt.title(\"Average Weekly Earnings by Gender\")\n",
        "    plt.xlabel(\"Sex (1 = Male, 2 = Female)\")\n",
        "    plt.ylabel(\"Mean Weekly Earnings\")\n",
        "    plt.grid(axis=\"y\", linestyle=\"--\", alpha=0.7)\n",
        "    plt.tight_layout()\n",
        "    plt.show()\n",
        "else:\n",
        "    raise ValueError(\"Required columns 'sex' and 'earnwke' not found in dataset.\")\n",
        "\n",
        "```\n",
        "\n",
        "\n",
        "Here is the chart\n",
        "\n",
        "![The graph I was created](../../images/earnings-by-gender.png)\n",
        "Followed by this text\n",
        "\"Here is the graph showing the gender gap in weekly earnings. Males (1) earn more on average than females (2) in this sample. Let me know if you want to adjust for hours worked or other covariates. \"\n",
        "\n",
        "\n",
        "```\n",
        "Yes, adjust by age.\n",
        "```\n",
        "\n",
        "![The graph I was created](../../images/earnings-by-gender-age1.png)\n",
        "\n",
        "Now what? By now, you have some idea, what you'd like. For me it was\n",
        "\n",
        "```\n",
        "Maybe binscatter by year, start 21. fit loess for makes and females\n",
        "```\n",
        "\n",
        "Try it!\n",
        "\n",
        "For me, it turns out it needed some adjustments after several iterations to get this. Add CI. Add Footnote. Increase FN font size. Add N of obs. Change color scheme. \n",
        "\n",
        "```{{python}}\n",
        "\n",
        "import matplotlib.cm as cm\n",
        "from matplotlib.colors import to_hex\n",
        "\n",
        "# Get viridis colors\n",
        "viridis = cm.get_cmap(\"viridis\", 2)\n",
        "color_male = to_hex(viridis(0.1))\n",
        "color_female = to_hex(viridis(0.8))\n",
        "\n",
        "# Count observations\n",
        "n_obs = len(reg_data)\n",
        "\n",
        "# Updated footnote\n",
        "footnote = (\n",
        "    f\"Notes: Residual hourly wages from a linear regression controlling for occupation (C(occ2012))\\n\"\n",
        "    f\"and education (C(grade92)), using 2014 CPS MORG data from California (N = {n_obs}). Residuals smoothed by\\n\"\n",
        "    f\"LOESS (span = 0.3), with 95% CI from 100 bootstrap replications. Sample restricted to individuals aged\\n\"\n",
        "    f\"21â€“80 with positive usual weekly hours and earnings.\"\n",
        ")\n",
        "\n",
        "# Plot\n",
        "plt.figure(figsize=(9, 6))\n",
        "\n",
        "plt.plot(x_m, y_m, label=\"Men\", color=color_male, linewidth=2)\n",
        "plt.fill_between(x_m, l_m, u_m, color=color_male, alpha=0.2)\n",
        "\n",
        "plt.plot(x_f, y_f, label=\"Women\", color=color_female, linewidth=2)\n",
        "plt.fill_between(x_f, l_f, u_f, color=color_female, alpha=0.2)\n",
        "\n",
        "plt.axhline(0, color=\"black\", linestyle=\"--\", linewidth=0.8)\n",
        "plt.title(\"Adjusted Gender Wage Gap Across Age\", fontsize=15)\n",
        "plt.xlabel(\"Age\", fontsize=12)\n",
        "plt.ylabel(\"Residual Hourly Wage (USD)\", fontsize=12)\n",
        "plt.xticks(fontsize=10)\n",
        "plt.yticks(fontsize=10)\n",
        "plt.grid(True, linestyle=\"--\", alpha=0.5)\n",
        "plt.legend(title=\"Gender\", labels=[\"Men\", \"Women\"], fontsize=10, title_fontsize=11)\n",
        "\n",
        "# Updated footnote with larger font\n",
        "plt.figtext(0.01, -0.12, footnote, fontsize=10, ha=\"left\", va=\"top\")\n",
        "\n",
        "plt.tight_layout(rect=[0, 0.12, 1, 1])\n",
        "plt.savefig(\"/mnt/data/gender_wage_gap_viridis_residuals.png\", dpi=300, bbox_inches=\"tight\")\n",
        "plt.show()\n",
        "\n",
        "```\n",
        "\n",
        "\n",
        "It took some iterations, starting with\n",
        "\n",
        "![Fourth iteration](../../images/earnings-by-gender-age2a.png)\n",
        "\n",
        "To get to something I liked. It made errors, forgot labels, and made coding errors. Check the process. \n",
        "\n",
        "![Fourth iteration](../../images/earnings-by-gender-age4.png)\n"
      ],
      "id": "3d14baf3"
    },
    {
      "cell_type": "code",
      "metadata": {},
      "source": [
        "import statsmodels.api as sm\n",
        "from sklearn.utils import resample\n",
        "\n",
        "# Restrict and prepare data for regression\n",
        "reg_data = df[\n",
        "    ['age', 'earnwke', 'uhours', 'sex', 'grade92', 'occ2012']\n",
        "].dropna()\n",
        "reg_data = reg_data[\n",
        "    (reg_data['age'] >= 21) & (reg_data['age'] <= 62) &\n",
        "    (reg_data['uhours'] > 0) & (reg_data['earnwke'] > 0)\n",
        "].copy()\n",
        "\n",
        "# Compute hourly wage\n",
        "reg_data['hourly'] = reg_data['earnwke'] / reg_data['uhours']\n",
        "\n",
        "# Residualize hourly wage on occ and grade\n",
        "X = pd.get_dummies(reg_data[['grade92', 'occ2012']].astype(\"category\"), drop_first=True)\n",
        "X = sm.add_constant(X)\n",
        "model = sm.OLS(reg_data['hourly'], X).fit()\n",
        "reg_data['resid'] = model.resid\n",
        "reg_data['gender'] = reg_data['sex'].map({1: 'Male', 2: 'Female'})\n",
        "\n",
        "# Define bootstrap function\n",
        "def bootstrap_loess(data, gender, x_col, y_col, span=0.3, n_boot=100):\n",
        "    from statsmodels.nonparametric.smoothers_lowess import lowess\n",
        "\n",
        "    subset = data[data['gender'] == gender]\n",
        "    x_vals = np.linspace(21, 80, 60)\n",
        "    y_boot = np.zeros((n_boot, len(x_vals)))\n",
        "\n",
        "    for i in range(n_boot):\n",
        "        boot_sample = resample(subset)\n",
        "        smoothed = lowess(boot_sample[y_col], boot_sample[x_col], frac=span, return_sorted=True)\n",
        "        y_interp = np.interp(x_vals, smoothed[:, 0], smoothed[:, 1])\n",
        "        y_boot[i, :] = y_interp\n",
        "\n",
        "    y_mean = y_boot.mean(axis=0)\n",
        "    y_low = np.percentile(y_boot, 2.5, axis=0)\n",
        "    y_high = np.percentile(y_boot, 97.5, axis=0)\n",
        "    return x_vals, y_mean, y_low, y_high\n",
        "\n",
        "# Run bootstrap LOESS for both genders\n",
        "x_m, y_m, l_m, u_m = bootstrap_loess(reg_data, 'Male', 'age', 'resid')\n",
        "x_f, y_f, l_f, u_f = bootstrap_loess(reg_data, 'Female', 'age', 'resid')\n",
        "\n",
        "# Colors and footnote\n",
        "import matplotlib.cm as cm\n",
        "from matplotlib.colors import to_hex\n",
        "\n",
        "viridis = cm.get_cmap(\"viridis\", 2)\n",
        "color_male = to_hex(viridis(0.1))\n",
        "color_female = to_hex(viridis(0.8))\n",
        "\n",
        "n_obs = len(reg_data)\n",
        "footnote = (\n",
        "    f\"Notes: Residual hourly wages from a linear regression controlling for occupation (C(occ2012))\\n\"\n",
        "    f\"and education (C(grade92)), using 2014 CPS MORG data from California (N = {n_obs}). Residuals smoothed by\\n\"\n",
        "    f\"LOESS (span = 0.3), with 95% CI from 100 bootstrap replications. Sample restricted to individuals aged\\n\"\n",
        "    f\"21â€“80 with positive usual weekly hours and earnings.\"\n",
        ")\n",
        "\n",
        "# Plot\n",
        "plt.figure(figsize=(9, 6))\n",
        "plt.plot(x_m, y_m, label=\"Men\", color=color_male, linewidth=2)\n",
        "plt.fill_between(x_m, l_m, u_m, color=color_male, alpha=0.2)\n",
        "plt.plot(x_f, y_f, label=\"Women\", color=color_female, linewidth=2)\n",
        "plt.fill_between(x_f, l_f, u_f, color=color_female, alpha=0.2)\n",
        "\n",
        "plt.axhline(0, color=\"black\", linestyle=\"--\", linewidth=0.8)\n",
        "plt.title(\"Adjusted Gender Wage Gap Across Age\", fontsize=15)\n",
        "plt.xlabel(\"Age\", fontsize=12)\n",
        "plt.ylabel(\"Residual Hourly Wage (USD)\", fontsize=12)\n",
        "plt.xticks(fontsize=10)\n",
        "plt.yticks(fontsize=10)\n",
        "plt.grid(True, linestyle=\"--\", alpha=0.5)\n",
        "plt.legend(title=\"Gender\", labels=[\"Men\", \"Women\"], fontsize=10, title_fontsize=11)\n",
        "plt.figtext(0.01, -0.12, footnote, fontsize=10, ha=\"left\", va=\"top\")\n",
        "plt.tight_layout(rect=[0, 0.12, 1, 1])\n",
        "plt.savefig(\"/mnt/data/gender_wage_gap_viridis_residuals.png\", dpi=300, bbox_inches=\"tight\")\n",
        "plt.show()"
      ],
      "id": "fd2706d0",
      "execution_count": null,
      "outputs": []
    },
    {
      "cell_type": "markdown",
      "metadata": {},
      "source": [
        "**Final thoughts **\n",
        "\n",
        "* While AI is great, it needed some iterations to get **what I want** not just something. \n",
        "\n",
        "* Oh, and you can go further. Think about this graph. Is the econonometrics of it okay? \n",
        "\n",
        "\n",
        "### Heatmap\n",
        "\n",
        "```\n",
        " Ok now show a heatmap of hourly wages by occupation and education level. Keep viridis. \n",
        " ```\n",
        " \n",
        "Not great\n",
        "\n",
        "```\n",
        "Create a few distinct categories of occupation.\n",
        "Then create bins for education.\n",
        "```\n",
        "\n",
        "Almost\n",
        "\n",
        "```\n",
        "Swap colors\n",
        "```\n",
        "\n",
        "Now we are talking:\n",
        "\n",
        "![Fourth iteration](../../images/earnings-heatmap.png)\n",
        "\n",
        "**Discussion points**\n",
        "\n",
        "Think about this for each iterations. \n",
        "\n",
        "* Is the code correct\n",
        "* What do we like and dislike in this graph? Look carefully on all aspects. How would you change it? \n",
        "* Go through the process and improve each graph to presenation quality. \n",
        "\n",
        "###\n",
        "\n",
        "### Bonus\n",
        "\n",
        "You made it till the end. Your bonus track is [California Love](https://www.youtube.com/watch?v=omfz62qu_Bc)"
      ],
      "id": "3604776d"
    }
  ],
  "metadata": {
    "kernelspec": {
      "display_name": "Python 3",
      "language": "python",
      "name": "python3"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}